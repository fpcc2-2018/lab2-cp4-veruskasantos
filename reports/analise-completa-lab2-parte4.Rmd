---
title: "Análise sobre dados de acesso de projetos da wikimedia"
author: "Veruska Santos"
date: "25 de abril de 2018"
output: html_document
---

Este relatório é a resposta do exercício proposto pelo Wikimedia, disponível no GitHub.

## Configurações

Abaixo estão as dependências necessárias para reproduzir este relatório.

```{r setup}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
```

O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv")) #TODO lembrar de usar todos os dados
```

## Objetivo

Neste relatório, analisaremos os dados busca e navegação de projetos do Wikimedia e tentaremos responder as seguintes perguntas, separadamente:

1- Qual é a taxa de cliques geral diária? Como isso varia entre os grupos?
2- Quais resultados as pessoas tendem a tentar primeiro? Como isso muda no dia-a-dia?
3- Qual é a taxa de resultados zero no geral? Como isso varia entre os grupos?
4- A duração da sessão é aproximadamente o tempo entre o primeiro e o último evento de uma sessão. Escolha uma variável do conjunto de dados e descreva sua relação com o tamanho da sessão. Visualize o relacionamento.

Utilizaremos de visualizações e discussões dos resultados para responder às perguntas.

## Distribuição dos dados utilizados

Vejamos a definição das variáveis coletadas e como estão distribuidos os dados na amostra disponibilizada.

**num_clicks:**
**group:**
**session_start_date:**
**results:**
**first_click:**
**[tamanho da sessão]**

```{r}
buscas %>% 
    ggplot(aes(x = num_clicks, fill = group)) + 
    geom_histogram(binwidth = 1) +
    facet_grid(~ group) +
    geom_rug(alpha = .7, color = "green")
```

```{r}
buscas %>% 
    ggplot(aes(x = group, fill = group)) + 
    geom_histogram(binwidth = 1, stat = "count")
```

```{r}
buscas %>% 
    ggplot(aes(x = results, fill = group)) + 
    geom_histogram(binwidth = 1) +
    geom_rug(alpha = .3) +
    facet_grid(~ group)
```


## Análise dos dados

```{r}
buscas <- mutate(buscas, date = date(session_start_date))
```

### 1- Qual é a taxa de cliques geral diária? Como isso varia entre os grupos?

Para responder esta pergunta, iremos usar as variáveis **num_clicks**, **session_start_date** e **group** e calcularemos a taxa, que é a soma dos cliques do dia dividido pelo total de buscas do referido dia, ou seja, 

**taxa de cliques** = soma dos cliques do dia / total de buscas do dia

A taxa de cliques diária geral varia entre aproximadamente 24% e 37% e é mostrada no gráfico abaixo, onde é possível perceber uma tendência decrescente, entre os dias 01 e 09 de março de 2016. O primeiro dia atingiu o maior valor, mais de 35% de cliques em relação às buscas desse dia. O menor valor ocorreu no penúltimo dia, 07 de março de 2016, e atingiu pouco menos de 25% de cliques.

```{r}
total_buscas_dia <- buscas %>% 
    group_by(date) %>% 
    count(date)

total_cliques <- buscas %>% 
    group_by(date) %>%
    summarise(clicks = sum(num_clicks))
    
merge_cliques_buscas <- merge(total_cliques, total_buscas_dia)

taxa_cliques_total <- merge_cliques_buscas%>%
    ggplot(aes(x = date, y = (clicks/n)*100)) + 
    geom_col(position = "dodge") +
    labs(x = "Dia", y = "Taxa de cliques (%)", 
         title = "Taxa de cliques diária geral")

print(taxa_cliques_total)
```

Mais abaixo mostramos a variação da taxa de cliques por grupo, onde há enorme discrepância. Observe.

```{r}

total_cliques <- buscas %>% 
    group_by(date, group) %>%
    summarise(clicks = sum(num_clicks))

merge_cliques_buscas <- merge(total_cliques, total_buscas_dia)

taxa_cliques_grupos <- merge_cliques_buscas %>%
    ggplot(aes(x = date, y = (clicks/n)*100, fill = group)) + 
    geom_col(position = "dodge") +
    labs(x = "Dia", y = "Taxa de cliques (%)", 
         title = "Taxa de cliques diária, por grupo")

print(taxa_cliques_grupos)
```

O grupo a apresenta as maiores taxas de cliques em todos os dias analisados e uma tendência decrescente no decorrer dos dias. Já o grupo b, apresenta uma certa relação crescente, apesar dos valores ainda serem mais baixos que os do grupo a.

### 2- Quais resultados as pessoas tendem a tentar primeiro? Como isso muda no dia-a-dia?

Para responder esta pergunta, iremos usar as variáveis **results**, **first_click** e **date**.

Como para buscas sem resultados, em geral, não há nenhum clique (há 4 exceções nos dados), removeremos as buscas cujo resultado foi zero e não possui valores registrados para o primeiro clique. Assim, filtraremos e analisaremos apenas as buscas que têm 1 ou mais resultadose valores de primeiro clique registrados.

```{r}
buscas_filtradas <- buscas %>%
    filter(results > 0, !is.na(first_click))

```

O filtro acima resultou em 33.187 dados que iremos analisar, sendo, 122 destes, buscas cujo índice do primeiro clique é maior que 100. Essas 122 buscas removeremos do gráfico abixo, para facilitar a visualização, mas em seguida os mostraremos novamente através do boxplot.

```{r}
buscas_filtradas %>% 
    filter(first_click <= 100) %>%
    ggplot(aes(x = first_click)) + 
    geom_histogram(binwidth = 1) +
    geom_rug(alpha = .5) + 
    scale_y_log10() +
    labs(x = "Posição do resultado no primeiro clique", y = "Ocorrências", 
         title = "Distribuição dos primeiros cliques dos usuários")
```

O eixo x do gráfico acima exibe qual foi o primeiro clique do usuário, ou seja, em qual posição o resultado da busca estava. Assim, os usuários tendem, claramente, a clicar no primeiro resultado da busca, depois no segundo e assim, sucessivamente, devido à tendência decrescente exibida no gráfico, o que indica que os algoritmos de rankeamento da plataforma estão adequados. Apesar disso, há poucos ocorrências, menos de 10 por posição, em que o primeiro clique do usuário foi em um resultado posicionado após 25 ou mais respostas. Há ainda uma elevação nos valores, após a metade do intervalo [0, 25] que, seguindo o padrão de configuração das páginas, significa os primeiros resultados da segunda ou terceira página.

Agora, verificaremos a preferência dos resultados por dia. O gráfico abaixo exibe os boxplots, representados pela cor verde, para cada dia. Os pontos são as buscas e o eixo y representa qual a posição do primeiro resultado que o usuário clicou.

```{r}
buscas_filtradas %>% 
    ggplot(aes(x = factor(date), y = first_click)) + 
    geom_boxplot(outlier.shape=NA, color = "#41d480", fill = "#41d480") +
    geom_jitter(alpha = .1, width = .3) +
    scale_y_log10() +
    labs(x = "Data", y = "Posição do resultado no primeiro clique", 
         title = "Distribuição dos primeiros cliques dos usuários, por dia")
```

Em geral, não há diferença significativa entre os primeiros cliques dos usuários entre os dias, porque os boxplots (retângulos verdes) parecem apresentar as mesmas características. Exceto no dia 04, onde houve mais cliques nos resultados de índices altos, ou seja, há mais pontos, que representam as buscas, na parte superior do gráfico. Em todos os dias, os resultados que os usuários clicam primeiro estão, em sua maioria, entre 1 e 3, aproximadamente, sendo o primeiro resultado da busca o valor mediano, confirmando os resultados obtidos no Gráfico x. No primeiro e no sexto dia desses dados há buscas em que os usuários clicaram nos resultados acima da posição 1000, o que dá indicíos de que os usuários são robôs.

### 3- Qual é a taxa de resultados zero no geral? Como isso varia entre os grupos?

Para responder esta pergunta, iremos usar as variáveis **results**, **group**.
Diferente da pergunta anterior, onde removemos as buscas cujo resultado era zero, agora iremos analisar a sua frequência em relação ao total de buscas.

```{r}
buscas_sem_resultado <- buscas %>%
    filter(results == 0)

total_com_resultado <- buscas %>% 
    summarise(n_total = n())

total_sem_resultado <- buscas_sem_resultado %>% 
    summarise(n_vazio = n())

merge(total_com_resultado, total_sem_resultado) %>%
    ggplot() + 
    geom_col(aes(x = "", y = n_total)) +
    geom_text(aes(x = "", y = n_total, label=n_total), vjust=1.6, color="white", size=3.5) +
    geom_col(aes(x = "", y = n_vazio), fill = "#41d480") +
    geom_text(aes(x = "", y = n_vazio, label=n_vazio), vjust=1.6, color="white", size=3.5) +
    labs(x = "", y = "Quantidade de buscas", 
         title = "Comparação do total de buscas que retornaram resultado vazio")

```

O gráfico acima mostra que há 25.127 buscas, de um total de 136234, que retornaram nenhum resultado, ou seja, **18%** de todas as buscas retornaram resultado vazio. Desses resultados vazios, 16902 foram do grupo a, que possuem 92056, enquanto 8225 foram do grupo b, que possuem 44178, como podemos ver logo abaixo. Portanto, **18%** das buscas do grupo a e **19%** do grupo b retornaram resultado vazio.

```{r}
total_com_resultado <- buscas %>% 
    group_by(group) %>%
    summarise(n_total = n())
    
total_sem_resultado <- buscas_sem_resultado %>% 
    group_by(group) %>%
    summarise(n_vazio = n())

merge(total_com_resultado, total_sem_resultado) %>%
    ggplot() + 
    geom_col(aes(x = group, y = n_total, fill = group)) +
    geom_text(aes(x = group, y = n_total, label=n_total), vjust=1.6, color="white", size=3.5) +
    geom_col(aes(x = group, y = n_vazio), fill = "#41d480") +
    geom_text(aes(x = group, y = n_vazio, label=n_vazio), vjust=1.6, color="white", size=3.5) +
    labs(x = "", y = "Quantidade de buscas", fill = "Grupo",
         title = "Comparação do total de buscas que retornaram resultado vazio")
    

```

Apesar do grupo b ter menos dados, a taxa de resultados vazio foi ligeiramente maior em relação ao grupo a. 
Será que se a distribuição dos dados coletados fossem igual, as buscas do grupo b teriam bem mais resultados vazios do que o grupo a? 

### 4- A duração da sessão é aproximadamente o tempo entre o primeiro e o último evento de uma sessão. Escolha uma variável do conjunto de dados e descreva sua relação com o tamanho da sessão. Visualize o relacionamento.

```{r}

```


